---
title: "Chelsea Models"
author: "Bryan Chen"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: 
---


```{r include = FALSE}
knitr::opts_chunk$set(echo = TRUE, messAge=FALSE, warning=FALSE)

library(tidyverse)
library(openxlsx)
library(ggplot2)
library(bootnet)
library(qgraph)
library(lavaan)
library(mgm)
library(glmnet)
```

```{r}
load('/Users/bryanchen/Desktop/Med School/Pre-Clerkships/Research/ABCD/processedData.RData')
```

## Descriptives
```{r, results='asis'}
# summary(tableby(isAD~Age + Gender + Education + das_executive_v2+das_emotional_v2+das_behavior_cognitive_v2 + das_total_v2 + gds_total +
#                  updrs_Total + FAStotal + `DX:`, alldata))


```

## Longitudinal Network
```{r}
type = rep('g', 31) # Treating as quasi-continuous
level = rep(1, 31)

baseline_matrix = data.matrix(baseline_data)
baseline_network = mgm(data = baseline_matrix,
                       type = type,
                       level = level,
                       k = 2,
                       lambdaSel = 'EBIC',
                       lambdaGam = 0.5,
                       ruleReg = 'AND',
                       pbar = FALSE)

year2_matrix = data.matrix(year2_FU)
year2_network = mgm(data = year2_matrix,
                    type = type,
                    level = level,
                    k = 2,
                    lambdaSel = 'EBIC',
                    lambdaGam = 0.5,
                    ruleReg = 'AND',
                    pbar = FALSE)

year4_matrix = data.matrix(year4_FU)
year4_network = mgm(data = year4_matrix,
                    type = type,
                    level = level,
                    k = 2,
                    lambdaSel = 'EBIC',
                    lambdaGam = 0.5,
                    ruleReg = 'AND',
                    pbar = FALSE)

baseline_predict = predict(object = baseline_network,
                           data = baseline_matrix,
                           errorCon = 'R2',
                           errorCat = 'CC')$error

year2_predict = predict(object = year2_network,
                           data = year2_matrix,
                           errorCon = 'R2',
                           errorCat = 'CC')$error

year4_predict = predict(object = year4_network,
                           data = year4_matrix,
                           errorCon = 'R2',
                           errorCat = 'CC')$error

baseline_predict$R2_CC = ifelse(!is.na(baseline_predict$R2), baseline_predict$R2, baseline_predict$CC)
year2_predict$R2_CC = ifelse(!is.na(year2_predict$R2), year2_predict$R2, year2_predict$CC)
year4_predict$R2_CC = ifelse(!is.na(year4_predict$R2), year4_predict$R2, year4_predict$CC)

p_baseline = qgraph(baseline_network$pairwise$wadj,
             vsize = 8,
             layout = "spring",
              pie = baseline_predict$R2_CC,
             edge.width = 1.5,
             edge.color = baseline_network$pairwise$edgecolor, 
             labels = colnames(baseline_data),
             palette = "pastel",
             GLratio = 2,
             legend.cex = .35)

p_year2 = qgraph(year2_network$pairwise$wadj,
             vsize = 8,
             layout = "spring",
              pie = year2_predict$R2_CC,
             edge.width = 1.5,
             edge.color = year2_network$pairwise$edgecolor, 
             labels = colnames(year2_matrix),
             palette = "pastel",
             GLratio = 2,
             legend.cex = .35)

p_year4 = qgraph(year4_network$pairwise$wadj,
             vsize = 8,
             layout = "spring",
              pie = year4_predict$R2_CC,
             edge.width = 1.5,
             edge.color = year4_network$pairwise$edgecolor, 
             labels = colnames(year4_matrix),
             palette = "pastel",
             GLratio = 2,
             legend.cex = .35)

## Cross-lagged
baseline_data_summed <- baseline_data %>%
  rowwise() %>%
  mutate(sleep_initiation_sum = sum(c_across(ends_with('_i')))) %>%
  mutate(sleep_maintenance_sum = sum(c_across(ends_with('_m')))) %>%
  select(negative_urgency, lack_of_planning, sensation_seeking, positive_urgency, lack_of_perseverance, duration, ends_with('_sum'))

year2_FU_summed <- year2_FU %>%
  rowwise() %>%
  mutate(sleep_initiation_sum = sum(c_across(ends_with('_i')))) %>%
  mutate(sleep_maintenance_sum = sum(c_across(ends_with('_m')))) %>%
  select(negative_urgency, lack_of_planning, sensation_seeking, positive_urgency, lack_of_perseverance, duration,  ends_with('_sum'))

k = 8
adjMat = matrix(0, k, k)
rsquare = rep(0, k)

baseline_matrix_summed <- data.matrix(baseline_data_summed)
year2_matrix_summed <- data.matrix(year2_FU_summed)
colnames(baseline_matrix_summed) <- paste0(colnames(baseline_matrix_summed), '.1')
colnames(year2_matrix_summed) <- paste0(colnames(year2_matrix_summed), '.2')
baseline_year2_combined_matrix <- cbind(baseline_matrix_summed, year2_matrix_summed)

for (i in 1:k) {
  set.seed(222)
  lassoreg = cv.glmnet(as.matrix(baseline_year2_combined_matrix[,1:k]), as.matrix(baseline_year2_combined_matrix[,(k+1)]),
                                 family = 'gaussian',
                                 alpha = 1,
                                 standardize = TRUE)
  lambda = lassoreg$lambda.min
  rsquare[i] = lassoreg$glmnet.fit$dev.ratio[which(lassoreg$lambda == lambda)]
  adjMat[1:k, i] = coef(lassoreg, s = lambda, exact = FALSE)[2: (k+1)]
}

# Plot
groups = append(rep('UPPS', 5), rep('SIPS', 3)) %>% factor
labels = c('negative_urgency', 'lack_of_planning', 'sensation_seeking', 'positive_urgency', 'lack_of_perseverance', 'duration', 'sleep_initiation_sum', 'sleep_maintenance_sum')
node_names = c('Negative Urgency', 'lack_of_planning', 'sensation_seeking', 'positive_urgency', 'lack_of_perseverance', 'duration', 'sleep_initiation_sum', 'sleep_maintenance_sum')

# diag(adjMat) = 0

test_fig = qgraph(adjMat, 
                vsize = 8,
                layout = 'circular',
                edge.width = 1.5,
                pie = rsquare,
                fade = TRUE,
                labels = labels,
                groups = groups,
                legend = TRUE,
                # nodeNames = node_names,
                palette = "pastel",
                GLratio = 2.5,
                edge.labels = TRUE)

centrality(test_fig)
centralityPlot(test_fig, include = 'all', orderBy = 'OutExpectedInfluence')

```